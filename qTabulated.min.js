/*!
 * @author Barrack Angujo
 * @twitter @angujomondi
 * @link https://github.com/angujo/qtable
 * @license MIT
 * @author angujo
 */
;(function(d){var c="qTable",e={url:null,sort:false,search:false,footer_url:null,transistOut:"zoomOut",rowClick:function(f,g){},pageRows:[20,30,50,100],pgn:5,searchCharacters:3,data:[],lazyLoad:false};function b(g,f){this.$element=d(g);this.settings=d.extend({},e,f);this._options=f;this.settings.pgn=parseInt(this.settings.pgn)<5?5:parseInt(this.settings.pgn);this.ajax=null;this.page=1;this.pages=0;this.data=[];this.dataCount=0;this.currentData=[];this.filteredData=[];this.columns=0;this.searched=false;this.sorted=false;this.overlay=null;this.rows=this.settings.pageRows[0];this._data_parameters();this.init()}d.extend(b.prototype,{init:function(){var i=d('<div class="q-tabulated"></div>'),f=d('<div class="qtable-responsive"></div>'),j=d('<div class="qtable-hc"><label>Rows:<select></select></label></div>'),g=d('<div class="qtable-fc"><div class="qtable-pd"></div><ul class="qtable-pagination"></ul></div>');j.appendTo(i);f.appendTo(i);g.appendTo(i);i.insertAfter(this.$element);this.$element.appendTo(f);this.$header=j;this.$footer=g;this._header();this._body();this._actions()},_header:function(){var o=this,f=[],p=0;for(var l=0;l<this.settings.pageRows.length;l++){this.$header.find("select").append('<option value="'+this.settings.pageRows[l]+'">'+this.settings.pageRows[l]+"</option>")}this.$element.find("thead>tr:last-child>th").each(function(){p++;if(d(this).data("qoptions")){o._qoptions(d(this),f)}});if(f.length){var m=d('<tr class="q-search"></tr>');for(var h=0;h<p;h++){var n="<th></th>";for(var g=0;g<f.length;g++){if(f[g].i==h){n="<th>"+f[g].f+"</th>";f.splice(g,1);break}}m.append(n)}m.insertAfter(this.$element.find("thead>tr:last-child"))}this.$element.find("thead>tr").each(function(){o.columns=d("th,td",this).length>o.columns?d("th,td",this).length:o.columns})},_qoptions:function(h,j){var f=h.data("qoptions").split(",");for(var g=0;g<f.length;g++){if(this.ajax&&!h.closest("th,td").data("qname").toString().length){continue}switch(f[g].trim()){case"sort":if(h.hasClass("q-sorted")){continue}h.addClass("q-sorted");h.html('<a class="q-sorter" href="javascript:void(0);">'+h.text()+"</a>");break;case"search":if(h.hasClass("q-searched")){continue}h.addClass("q-searched");j.push({i:h.closest("th,td").index(),f:'<input name="'+(h.closest("th,td").data("qname").toString().length&&this.ajax?h.closest("th,td").data("qname"):"")+'">'});break}}},_body:function(){if(!this.$element.find("thead").length){alert("Tables should have <THEAD/> tags!");return}if(!this.$element.find("tbody").length){var f=d("<tbody></tbody>");this.$element.find("thead").siblings().appendTo(f);f.insertAfter(this.$element.find("thead"))}if(this.ajax){this._ajax()}else{this._basic()}},_ajax:function(){var i=this,g=this.ajax.lazyPage?(this.ajax.lazyPage+1):i.page,h=this.ajax.lazyRows?(this.ajax.lazyRows):i.rows,j={start:((g-1)*h),length:h},f=Date.now();j=d.extend({},j,this.ajax.data);if(this.ajax.run&&this.ajax.status){this.ajax.run.abort()}this.ajax.run=d.ajax(i.ajax.url,{cache:false,beforeSend:function(){i._overlayStart();i.ajax.status=true},complete:function(){i._overlayStop();i.ajax.status=false},data:{qtable:j},dataType:"json",error:function(){if(!i.ajax.status){alert("Error encountered. Log this on https://github.com/angujo/qtable")}},method:"get",success:function(k){if(!i.ajax.lazy||(i.ajax.lazy&&i.ajax.lazyPage==0)){i.data=k.data;i.dataCount=i.ajax.lazy?k.data.length:k.total;i.ajax.lazyTotal=k.total;i.ajax.lazyRows=i.rows;i._setData()}i._lazyStatus(k.data,(Date.now()-f))}})},_lazyStatus:function(h,k){if(!this.ajax.lazy){return}this.ajax.lazyPage++;var j=0,i=this;if(this.ajax.lazyPage>1){j=((this.data.length*100)/this.ajax.lazyTotal);this.data=this.data.concat(h)}var l=((this.data.length*100)/this.ajax.lazyTotal),f=(l-j),g=(0.1*k)/(0>=f?(j):f);this.dataCount=this.data.length;this._footer();this._lazyProgress(j);if(this.ajax.lazyLapse){clearInterval(this.ajax.lazyLapse)}this.ajax.lazyLapse=setInterval(function(){j=j+0.1;if(j>=l){clearInterval(i.ajax.lazyLapse);i.ajax.lazyLapse=null}else{i._lazyProgress(j)}},g);if(this.ajax.lazyTotal>this.data.length){this._ajax()}},_lazyProgress:function(g){g=+g.toFixed(1);var f=this.$header.parent().find(".q-lazy-progress");if(!this.$header.parent().find(".q-lazy-progress").length){f=d('<div class="q-lazy-progress" style="display: none;"><span class="q-indicator"></span><span class="q-lazy-progress-arrow-holder"><span class="q-lazy-progress-arrow"></span></span></div>');f.insertAfter(this.$header);f.slideDown(300)}f.find("span.q-indicator").css({width:g+"%"});f.find("span.q-lazy-progress-arrow").text(g+"%");if(g>=100){setTimeout(function(){f.slideUp(300)},3000)}},_basic:function(){this._overlayStart();var f=[];if(this.settings.data.length){this.ajax=null;f=this.settings.data}else{this.$element.find("tbody>tr").each(function(){var g=[];d(this).find("td,th").each(function(){g.push(d(this).html())});f.push(g)})}this.data=f;this.dataCount=f.length;this._setData()},_data_parameters:function(){this.settings.url=this.$element.data("url")?this.$element.data("url"):this.settings.url;if(this.settings.url){this.ajax={url:this.settings.url,data:{},run:null,status:false,lazy:this.settings.lazyLoad,lazyPage:0,lazyTotal:0,lazyLapse:null,lazyRows:0}}},_setData:function(){if(this.ajax&&!this.ajax.lazy){this.currentData=JSON.parse(JSON.stringify(this.data))}else{var k=((this.page-1)*this.rows),f=k+this.rows;this.currentData=this.searched||this.sorted?this.filteredData.slice(k,f):this.data.slice(k,f)}this._remove();if(this.currentData.length){for(var h=0;h<this.currentData.length;h++){var m=[],f=(this.currentData[h].length>this.columns||this.currentData[h].length<this.columns)?this.columns:this.currentData[h].length;for(var g=0;g<f;g++){m.push("<td>"+this.currentData[h][g]+"</td>")}this.$element.find("tbody").append("<tr>"+m.join("")+"</tr>")}}else{this.$element.find("tbody").html('<tr><td colspan="'+this.columns+'"><div class="q-no-data">No Data loaded...</div></td></tr>')}this._footer();this._overlayStop()},_remove:function(){this.$element.find("tbody").html("")},_footer:function(){var j=Math.ceil(this.dataCount/(this.rows<=0?1:this.rows)),l=[],i=0,m=0,k=(this.settings.pgn%2)?this.settings.pgn:(this.settings.pgn+1);var h=Math.ceil(k/2);this.page=this.page>j?j:(this.page<=0?1:this.page);if(j<=k||this.page<=h){var f=j>k?k:j;for(m=1;m<=f;m++){l.push(m)}}else{if(this.page>=(j-(h-1))){for(m=j;m>=(j-k);m--){l.push(m)}l.reverse()}else{i=this.page-(h-1);for(m=0;m<k;m++){l.push(i+m)}}}this.$footer.find(".qtable-pd").html("");this.$footer.show();if(l.length>1){this.$footer.find(".qtable-pd").html("Page <b>"+this.page+"</b> of <b>"+j+"</b>");if(this.page>=l[0]||this.page<=l[(l.length-1)]){this.$footer.find(".qtable-pagination").html("");if(1<l[0]){this.$footer.find(".qtable-pagination").append('<li><a data-pg="1">|<</a></li>');this.$footer.find(".qtable-pagination").append('<li><a data-pg="'+(this.page-1)+'"><</a></li>')}for(m=0;m<l.length;m++){var g=l[m]==this.page?'class="active"':"";this.$footer.find(".qtable-pagination").append("<li "+g+'><a data-pg="'+l[m]+'">'+l[m]+"</a></li>")}if(j>l[(l.length-1)]){this.$footer.find(".qtable-pagination").append('<li><a data-pg="'+(this.page+1)+'">></a></li>');this.$footer.find(".qtable-pagination").append('<li><a data-pg="'+j+'">>|</a></li>')}}}else{this.$footer.find(".qtable-pagination").html("");this.$footer.hide()}},_actions:function(){var f=this;this.$footer.on("click","li:not(.active) a",function(){f.page=d(this).data("pg");if(f.ajax&&!f.ajax.lazy){f._ajax()}else{f._setData()}});this.$header.on("change","select",function(){f.page=1;f.rows=parseInt(d(this).val());if(f.ajax&&!f.ajax.lazy){f._ajax()}else{f._setData()}});this.$element.on("click","thead>tr>th>a.q-sorter",function(){if(d(this).hasClass("qsort-asc")){d(this).removeClass("qsort-asc").addClass("qsort-desc")}else{if(d(this).hasClass("qsort-desc")){d(this).removeClass("qsort-desc")}else{d(this).addClass("qsort-asc")}}f._manipulate()});this.$element.on("keyup","thead>tr.q-search input",function(){f._manipulate()})},_manipulate:function(){this._search();this._sort();if(this.ajax&&!this.ajax.lazy){this._ajax()}else{this._setData()}},_search:function(){var m=this.ajax&&!this.ajax.lazy?{}:[],k=this;this.$element.find("thead>tr.q-search input").each(function(){if(!d(this).val()||k.settings.searchCharacters>d(this).val().length){return true}if(k.ajax&&!k.ajax.lazy){if(d(this).attr("name").toString().length){m[d(this).attr("name")]=d(this).val()}}else{m.push({i:d(this).closest("th,td").index(),v:d(this).val()})}});if(this.ajax&&!this.ajax.lazy){this.ajax.data.search=m;return}if(m.length){this.searched=true;var l=this.sorted?this.filteredData:JSON.parse(JSON.stringify(this.data));this.filteredData=[];for(var g=0;g<l.length;g++){var h=true;for(var f=0;f<m.length;f++){if(l[g][m[f].i].toString().toLowerCase().indexOf(m[f].v.toString().toLowerCase())==-1){h=false;break}}if(h){this.filteredData.push(l[g])}}}else{this.searched=false;this.filteredData=this.sorted?this.filteredData:[]}this.page=1;this.dataCount=this.searched||this.sorted?this.filteredData.length:this.data.length},_sort:function(){var h=this.ajax&&!this.ajax.lazy?{}:[],g=this;this.$element.find("thead tr a.q-sorter.qsort-asc,thead tr a.q-sorter.qsort-desc").each(function(){if(g.ajax&&!g.ajax.lazy){if(d(this).closest("th,td").data("qname").toString().length){h[d(this).closest("th,td").data("qname")]=(d(this).hasClass("qsort-desc")?"desc":"asc")}}else{h.push({i:d(this).closest("th,td").index(),o:d(this).hasClass("qsort-desc")})}});if(this.ajax&&!this.ajax.lazy){this.ajax.data.order=h;return}if(h.length){this.sorted=true;this.filteredData=this.searched?this.filteredData:JSON.parse(JSON.stringify(this.data));for(var f=0;f<h.length;f++){(function(k,j){j.filteredData.sort(function(m,i){var l=m[h[k].i],n=i[h[k].i];if(h[k].o){l=i[h[k].i];n=m[h[k].i]}if(!isNaN(l)&&!isNaN(n)){return l-n}l=l.toString();n=n.toString();return l.localeCompare(n)})})(f,this)}}else{this.sorted=false;this.filteredData=this.searched?this.filteredData:[]}},_overlayStart:function(){if(!this.overlay){this.overlay=d('<div class="qtable-overlay"><span>Loading Data...</span></div>');this.overlay.prependTo(this.$element.parent())}this.overlay.css({display:"flex",top:this.$element.find("tbody").offset().top,bottom:this.$element.find("tbody").offset().bottom})},_overlayStop:function(){if(this.overlay){this.overlay.css({display:"none"})}}});var a={set_data:function(f){this.ajax=null;this.page=1;this.data=f;this.dataCount=f.length;this._setData()},gotoPage:function(f){this.page=f;if(this.ajax){this._ajax()}else{this._setData()}},reload:function(){var g=this._options,f=this.$element;this.destroy();f.qTable(g)},refresh:function(){this.reload()},destroy:function(){this.$element.insertAfter(this.$header.parent());this.$header.parent().remove();this.$element.find("thead>tr.q-search").remove();this.$element.find(".q-searched").removeClass("q-searched");this.$element.find(".q-sorted").each(function(){d(this).html(d(this).find(".q-sorter").html()).removeClass("q-sorted")});if(this.ajax){}else{this.rows=this.data.length;this.page=1;this._setData()}d.removeData(this.$element.get(0),"plugin_"+c)},tester:function(){console.log(arguments)}};d.fn[c]=function(h,f){var g=arguments;return this.each(function(){if(!d(this).is("table")){return true}if((!h||(h&&typeof h=="object")||"create"==h)&&!d.data(this,"plugin_"+c)){d.data(this,"plugin_"+c,new b(this,h))}else{if(a[h]){if(!d.data(this,"plugin_"+c)){return true}g=d.map(g,function(i){return i});g.shift();a[h].apply(d.data(this,"plugin_"+c),g)}}})}})(jQuery,Window,Document);